<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Ký - UTH FaceID</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary-color: #00897B;
            --primary-hover: #00796B;
            --danger-color: #D32F2F;
            --bg-color: #158C8F;
            --gray-border: #ccc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: white;
            width: 100%;
            max-width: 420px;
            padding: 40px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .logo img {
            height: 60px;
            margin-bottom: 20px;
        }

        .title {
            color: var(--danger-color);
            font-size: 22px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            text-align: left;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 15px;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
        }

        .btn-init-face {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--primary-color);
            background-color: #E0F2F1;
            color: var(--primary-color);
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .btn-init-face:hover {
            background-color: #B2DFDB;
        }

        .camera-wrapper {
            display: none;
            margin-bottom: 20px;
            position: relative;
            border: 2px solid var(--gray-border);
            border-radius: 10px;
            padding: 10px;
            background: #000;
        }

        .camera-wrapper.status-ok {
            border-color: #00E676;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
        }

        .camera-wrapper.status-bad {
            border-color: #FF1744;
            box-shadow: 0 0 15px rgba(255, 23, 68, 0.4);
        }

        .video-container {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        .status-text {
            color: white;
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            z-index: 10;
        }

        .btn-submit {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 700;
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
            transition: 0.3s;
        }

        .btn-submit.active {
            opacity: 1;
            pointer-events: auto;
        }

        .btn-submit:hover.active {
            background-color: var(--primary-hover);
        }

        #page-loader {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 9999;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="page-loader">
        <div class="spinner"></div> Đang tải AI Model...
    </div>

    <div class="login-card">
        <div class="logo">
            <img src="/static/img/logo_uth.png" alt="UTH Logo">
        </div>
        <h2 class="title">Đăng Ký Tài Khoản</h2>
        <p class="subtitle">Hệ thống nhận diện khuôn mặt AI</p>

        <form id="registerForm">
            <div class="form-group">
                <input type="text" id="username" class="form-input" placeholder="Tài khoản đăng nhập" required>
            </div>
            <div class="form-group">
                <input type="password" id="password" class="form-input" placeholder="Mật khẩu" required>
                <span class="material-icons toggle-password" onclick="togglePassword()">visibility</span>
            </div>

            <button type="button" class="btn-init-face" id="btnInitFace" onclick="activateCamera()">
                <span class="material-icons">face</span> Tiến hành đăng ký khuôn mặt
            </button>

            <div class="camera-wrapper" id="cameraSection">
                <div class="video-container">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="overlayCanvas"></canvas>
                    <p class="status-text" id="aiStatus">Đang khởi động camera...</p>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn">ĐĂNG KÝ</button>

            <div class="footer-links"
                style="margin-top:20px; font-size:14px; display:flex; justify-content:space-between;">
                <a href="/login" style="color:#D32F2F; text-decoration:none; font-weight:bold;">Đã có tài khoản? Đăng nhập</a>
                <a href="#" style="color:#00897B; text-decoration:none;">Cần hỗ trợ?</a>
            </div>
        </form>
    </div>

    <!-- 1. IMPORT THƯ VIỆN FACE API (Sử dụng Unpkg ổn định hơn) -->
    <script src="/static/js/face-api.min.js"></script>

    <!-- 2. CODE LOGIC (Chỉ chạy khi thư viện đã tải xong) -->
    <script>
        const video = document.getElementById('video');
        const cameraSection = document.getElementById('cameraSection');
        const btnInitFace = document.getElementById('btnInitFace');
        const aiStatus = document.getElementById('aiStatus');
        const submitBtn = document.getElementById('submitBtn');
        const pageLoader = document.getElementById('page-loader');

        let isModelLoaded = false;
        let finalFaceImage = null;
        let detectionInterval;

        // Hàm kiểm tra và tải Model
        async function initApp() {
            // Kiểm tra xem thư viện đã tải chưa
            if (typeof faceapi === 'undefined') {
                pageLoader.innerHTML = '<span style="color:red;">⚠ Lỗi kết nối AI Lib</span>';
                alert("Lỗi: Không thể tải thư viện AI. Vui lòng kiểm tra mạng!");
                return;
            }

            try {
                // Load model
                const MODEL_URL = '/models';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);

                isModelLoaded = true;
                pageLoader.innerHTML = '<span style="color:#4CAF50;">✔ AI Sẵn sàng</span>';
                setTimeout(() => { pageLoader.style.display = 'none'; }, 2000);
                console.log("Model AI Loaded Successfully!");
            } catch (err) {
                console.error("Lỗi tải Model:", err);
                pageLoader.innerHTML = '<span style="color:red;">✖ Lỗi tải Model</span>';
                alert("Không tải được Model AI. Bạn hãy thử chạy trên Localhost (Live Server)!");
            }
        }

        // Chạy hàm khởi tạo ngay khi trang web tải xong
        window.addEventListener('load', initApp);

        async function activateCamera() {
            if (!isModelLoaded) {
                alert("AI chưa sẵn sàng. Vui lòng đợi biểu tượng 'Đang tải AI' ở góc phải biến mất.");
                return;
            }

            btnInitFace.style.display = 'none';
            cameraSection.style.display = 'block';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
            } catch (err) {
                aiStatus.innerText = "Lỗi Camera: " + err.message;
                aiStatus.style.color = "red";
                alert("Vui lòng cấp quyền Camera cho trình duyệt!");
            }
        }

        video.addEventListener('play', () => {
            const canvas = document.getElementById('overlayCanvas');
            const displaySize = { width: video.videoWidth || 300, height: video.videoHeight || 250 };
            faceapi.matchDimensions(canvas, displaySize);

            aiStatus.innerText = "Đang khởi động nhận diện...";

            detectionInterval = setInterval(async () => {
                if (!video.srcObject) return; // Nếu cam chưa lên thì không check

                const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);

                if (detections) {
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    const score = detections.score;

                    if (score > 0.9) {
                        cameraSection.className = "camera-wrapper status-ok";
                        aiStatus.innerText = "Khuôn mặt hợp lệ";
                        aiStatus.style.color = "#00E676";

                        const box = resizedDetections.box;
                        const drawBox = new faceapi.draw.DrawBox(box, { label: 'OK', boxColor: '#00E676' });
                        drawBox.draw(canvas);

                        captureHighQualityFace();
                        submitBtn.classList.add('active');
                    } else {
                        cameraSection.className = "camera-wrapper status-bad";
                        aiStatus.innerText = "Giữ yên và nhìn thẳng...";
                        aiStatus.style.color = "yellow";
                        submitBtn.classList.remove('active');
                    }
                } else {
                    cameraSection.className = "camera-wrapper status-bad";
                    aiStatus.innerText = "Đang tìm khuôn mặt...";
                    aiStatus.style.color = "#FF1744";
                    submitBtn.classList.remove('active');
                }
            }, 200);
        });

        function captureHighQualityFace() {
            const tmpCanvas = document.createElement('canvas');
            tmpCanvas.width = video.videoWidth;
            tmpCanvas.height = video.videoHeight;
            const ctx = tmpCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            finalFaceImage = tmpCanvas.toDataURL('image/jpeg', 0.9);
        }

        // --- 4. GỬI DỮ LIỆU VỀ BACKEND (Đã cập nhật) ---
        document.getElementById('registerForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!finalFaceImage) {
                alert("Chưa nhận diện được khuôn mặt! Vui lòng thử lại.");
                return;
            }

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('submitBtn');

            // Hiệu ứng đang gửi
            btn.innerText = "ĐANG XỬ LÝ...";
            btn.style.opacity = "0.7";

            const requestData = {
                username: username,
                password: password,
                image_base64: finalFaceImage
            };

            try {
                // Gọi API Python chạy ở cổng 8000
                const response = await fetch('http://127.0.0.1:8000/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert("✅ " + result.message);
                    // Reset form sau khi thành công
                    location.reload();
                } else {
                    alert("❌ Lỗi: " + result.detail);
                    btn.innerText = "ĐĂNG KÝ";
                    btn.style.opacity = "1";
                }

            } catch (error) {
                console.error("Lỗi kết nối:", error);
                alert("❌ Không thể kết nối đến Server Backend (Kiểm tra xem file main.py đã chạy chưa?)");
                btn.innerText = "ĐĂNG KÝ";
                btn.style.opacity = "1";
            }
        });

        function togglePassword() {
            const x = document.getElementById("password");
            x.type = x.type === "password" ? "text" : "password";
        }
    </script>
</body>

</html>